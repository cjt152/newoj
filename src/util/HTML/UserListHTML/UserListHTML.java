package util.HTML.UserListHTML;

import util.Main;
import entity.User;
import util.HTML.FromHTML.FormHTML;
import util.HTML.FromHTML.hidden.hidden;
import util.HTML.FromHTML.text.text;
import util.HTML.HTML;
import util.HTML.pageBean;

import java.util.List;

/**
 * Created by Syiml on 2015/6/24 0024.
 */
public class UserListHTML extends pageBean {
    List<User> list;
    User u=null;//当前登录的用户
    int num,page;

    int inTeamStatus;

    int pageNum;
    String search="";
    String order;
    boolean desc;
    public UserListHTML(int page,String search,String order,boolean desc,int inTeamStatus){
        this.order=order;
        this.desc = desc;
        this.inTeamStatus=inTeamStatus;
        if(search!=null) this.search=search;
        if(page>0) this.page = page;
        num=Main.config.topConfig.userShowNum;
        if(inTeamStatus!=-1){//取到了status的值
            list= Main.users.getUsersInTeam((page-1) * num, num, search,order, desc,inTeamStatus);
        }else{//全部
            list= Main.users.getUsers((page-1) * num, num, search,order, desc);
        }
        if(inTeamStatus!=-1){//集训
            pageNum= getTotalPageNum(Main.users.getUsersNumInTeam(search,inTeamStatus),num);
        }else{
            pageNum= getTotalPageNum(Main.users.getUsersNum(search),num);
        }
        u=Main.loginUser();
        addTableHead("rank","username");
        if(u!=null&&u.getPermission().getUserAdmin()) addTableHead("name");
        addTableHead("nick","motto","acnum","acb","rating","ratingnum");
        setCl("table table-striped table-hover table-condensed");
    }
    private String search(){
        FormHTML f=new FormHTML();
        f.setType(1);
        text t=new text("search", "查找");
        t.setValue(search);
        t.setPlaceholder("UserName/Nick");
        f.addForm(t);
        f.setAction("User.jsp");
        f.addForm(new hidden("order", order));
        if(inTeamStatus!=-1) f.addForm(new hidden("status", inTeamStatus+""));
        if(desc)
            f.addForm(new hidden("desc","1"));
        f.setSubmitText("确定");
        return f.toHTML();
    }
    private String getHead(String name,String label,boolean def){
        String s="";
        if(order!=null&&order.equals(name)){
            if(desc) s="↓";
            else s="↑";
        }
        StringBuilder link=new StringBuilder("");
        if(order==null||!order.equals(name)||(order.equals(name)&& desc !=def)){
            link.append("&order=").append(name);
            if(def) link.append("&desc=1");
            if(inTeamStatus!=-1) link.append("&status=").append(inTeamStatus);
        }else{
            link.append("&order=").append(name);
            if(!def) link.append("&desc=1");
            if(inTeamStatus!=-1) link.append("&status=").append(inTeamStatus);
        }
        return HTML.a("User.jsp?search="+search+link,label+s);
    }

    @Override
    public String getTitle() {
        return "用户排名";
    }

    @Override
    public String getColname(String colname){
        if(colname.equals("rank")) return (getHead("rank", "Rank", false));
        if(colname.equals("name")) return "Name";
        if(colname.equals("username")) return (getHead("username","UserName",false));
        if(colname.equals("nick")) return (getHead("nick","Nick",false));
        if(colname.equals("motto")) return (getHead("motto","Motto",false));
        if(colname.equals("acnum")) return (getHead("acnum","AC",true));
        if(colname.equals("acb")) return (getHead("acb","ACB",true));
        if(colname.equals("rating")) return (getHead("rating","Rating",true));
        if(colname.equals("ratingnum")) return (getHead("ratingnum","#",true));
        return "=ERROR=";
    }

    @Override
    public int getCurrPageSize() {
        return list.size();
    }

    @Override
    public int getTotalPageNum() {
        return pageNum;
    }

    @Override
    public int getCurrPage() {
        return page;
    }

    @Override
    public String getCellByHead(int i, String colname) {
        User s=list.get(i);
        if(colname.equals("rank")){
            return s.getRank()+"";
        }
        if(colname.equals("username")){
            addClass(i+1,3,"break");
            addClass(i+1,2,"break");
            addClass(i+1,1,"break");
            if(u!=null && u.getUsername().equals(s.getUsername())){
                addClass(i+1,-1,"info");
            }
            return s.getUsernameHTML();
        }
        if(colname.equals("name")){
            return s.getName();
        }
        if(colname.equals("nick")){
            return s.getTitleAndNick();
        }
        if(colname.equals("motto")){
            return s.getMotto();
        }
        if(colname.equals("acnum")){
            return s.getAcnum()+"";
        }
        if(colname.equals("acb")) {
            return s.getAcb()+"";
        }
        if(colname.equals("rating")){
            return s.getRatingHTML();
        }
        if(colname.equals("ratingnum")){
            return s.getRatingnum()+"";
        }
        return "=ERROR=";
    }

    @Override
    public String getLinkByPage(int page) {
        if(inTeamStatus!=-1){
            return "User.jsp?status=1&page="+page+(search==null?"":"&search="+search)+(order==null?"":"&order="+order)+(desc ?"&desc=1":"");
        }
        else{
            return "User.jsp?page="+page+(search==null?"":"&search="+search)+(order==null?"":"&order="+order)+(desc ?"&desc=1":"");
        }
    }

    @Override
    public String rightForm() {
        return search();
    }

}
